<?php
/**
 * @var BafS\PsalmTypecov\Report\Thresholds $thresholds
 * @var iterable<string, array{int, int}> $result
 * @var non-empty-string $coverageClass
 */
?><!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Psalm-Typecov</title>
    <style>
        <?= file_get_contents(__DIR__ . '/bootstrap-reboot.min.css') ?>
        <?= file_get_contents(__DIR__ . '/style.css') ?>
    </style>
</head>
<body>
<div class="container">
    <table id="coverage-table" class="table">
        <thead>
            <tr>
                <th>Psalm-Typecov</th>
                <th data-sort-method="number" colspan="3">Coverage</th>
            </tr>
            <tr>
                <th>Files</th>
                <th data-sort-method="number">Percent</th>
                <th data-sort-method="number">Mixed</th>
                <th data-sort-method="number">Non-mixed</th>
            </tr>
        </thead>
        <tbody>
        <?php foreach ($result as $file_path => [$path_mixed_count, $path_nonmixed_count]) { ?>
            <?php $total = $path_mixed_count + $path_nonmixed_count ?>
            <tr class="<?= $coverageClass($path_nonmixed_count, $total) ?>">
                <td><?= $file_path ?></td>
                <td data-sort-method="number"><?= number_format(100 * $path_nonmixed_count / $total, 3) ?>%</td>
                <td data-sort-method="number"><?= $path_mixed_count ?></td>
                <td data-sort-method="number"><?= $path_nonmixed_count ?></td>
            </tr>
        <?php } ?>
        </tbody>
    </table>

    <div class="legend">
        <div class="coverage-low">Low: 0% to <?= $thresholds->lowUpperBound ?>%</div>
        <div class="coverage-medium">Medium: <?= $thresholds->lowUpperBound ?>% to <?= $thresholds->highLowerBound ?>%</div>
        <div class="coverage-high">High: <?= $thresholds->highLowerBound ?>% to 100%</div>
    </div>

    <div class="footer">
        Generated by Psalm-Typecov (<?= date('r') ?> with PHP version <?= PHP_VERSION ?>)
    </div>
</div>

<script>
    <?= file_get_contents(__DIR__ . '/tablesort.min.js') ?>

    new Tablesort(document.getElementById('coverage-table'));

    const cleanNumber = (i) => i.replace(/[^\-?0-9.]/g, '');

    const compareNumber = function(a, b) {
        a = parseFloat(a);
        b = parseFloat(b);

        a = isNaN(a) ? 0 : a;
        b = isNaN(b) ? 0 : b;

        return a - b;
    };

    Tablesort.extend(
        'number',
        (item) => item.match(/^[-+]?(\d)*-?([,\.]){0,1}-?(\d)+%?$/), // Number
        (a, b) => compareNumber(cleanNumber(b), cleanNumber(a)),
    );
</script>

</body>
</html>
